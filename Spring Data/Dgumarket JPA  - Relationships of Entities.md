# Dgumarket - Relationship of Entity on 회원 : 상품



<그림 1 : 회원 : 상품 엔티티 구조도> 

**동국대학교 중고거래 플랫폼** 프로젝트 내 엔티티 간 연관관계를 어떻게 설정했는 지에 대한 글이에요. 가장 핵심이 되는 엔티티 간의 관계를 정의하고 각 관계가 어떤 이유로 설정됐는 지를 설명해보려고 합니다.

**중고거래 플랫폼**이라는 상황이라서 아마 대부분 JPA 연관관계 주제로 많은 책 또는 블로그에서 다루는 예제와가 많아 익숙하실 것 같아요 :-) 저희 팀 프로젝트에서 **회원 : 상품** 관계를 어떻게 정의했고, 즉시 로딩과 지연로딩 그리고 영속성 전이 (Transitive Persitence)와 관련한 주제를 소개하려고 합니다.

피드백 및 질문은 언제나 환영이고. 적극적인 피드백 부탁드립니다.

___

## 엔티티 관계, 방향성

### **회원 : 상품 = One :  Many ** <-> 상품 : 회원 = Many : One

우선 회원과 상품의 관계는 양방향 관계로 설정했어요. 객체 그래프 탐색 기능이 양 엔티티 기준으로 모두 필요한 상황이었기 때문인데요. 양방향 관계 설정에서는 두 엔티티 간 관계에 있어서 주인(Owner)를 지정해야 하는데, '다' 측면인 상품을 주인으로 설정했습니다. 테이블 관계에서는 사실 한 쪽에만 외래 키가 존재해도 'join' 문을 통해서 양방향 관계를 설정할 수 있는데요, 엔티티 관계에서는 양방향 관계를 설정할 때 양 쪽 엔티티에 서로를 참조할 수 있는 필드가 필요합니다. 그리고 주인-종속 관계를 따로 지정해야 하는 이유는 두 엔티티에 서로를 참조할 수 있는 필드 중 어떤 필드를 기준으로 조회할 것인 지를 JPA에 알려줘야 하기 때문입니다.

주인-종속 관계를 설정할 때는 **mappedBy** 속성을 사용하는데, 종속 관계에 있는 엔티티 필드에 설정하면 돼요. 정리하면 **mappedBy**가 있는 엔티티가 양방향 관계를 맺고 있는 두 엔티티 간 관계에서 종속 관계에 있는 것이죠! 여기서 종속이라는 말에 집중하기 보다는 앞서 언급한 것처럼 두 엔티티를 조회할 때 어떤 필드를 기준으로 조회할 지 지정한다는 개념을 인지하는 것이 직관적인 이해를 도울 것 같습니다.! (저는 종속이라는 말 그대로의 의미로 다소 이해하는데 어려움이 있었습니다!)

**1) 회원 ---> 상품** 

- 회원의 구매 상품 리스트 조회
- 회원의 판매 상품 리스트 조회

**2) 상품 ---> 회원** 

- 상품의 업로더인 지 확인 여부 (상품의 수정, 삭제 권한 체크 등과 같은 서비스 로직을 위함)

___

## 즉시 로딩? 지연 로딩? 

이 주제와 관련해서 우리 프로젝트에서 취한 전략은 **회원 : 상품** 두 객체 관계에서 연관된 정보를 조회하는 상황들을 하나씩 정리해봤습니다. 앞서 위에서 정리한 것을 참고했을 때 저는 지연로딩 전략을 취하는 것이 직관적으로 합리적 판단이라고 생각했었습니다. 예를 들어, 전체 프로젝트에서 회원정보만을 다루는 페이지에서 상품의 정보를 불러올 이유가 없고, 상품 리스트에서 상품의 업로더가 누구인 지 판단하는 시점에 유저의 정보를 조회하는 것이 더 자연스러웠기 때문입니다. 하지만 이는 정확한 근거가 부족한 생각이라고 판단했고, 보다 합리적인 근거를 찾기 위해 자료를 찾던 중 아래와 같은 방향으로 결정하게 됐습니다.

```
회원 ---> 상품 (@OneToMany) : 지연 로딩 (JPA 디폴트 설정 : 즉시 로딩)

상품 ---> 회원 (@ManyToOne) : 지연 로딩 (JPA 디폴트 설정 : 지연 로딩)
```

 김영한 님의 "자바 ORM 표준 JPA 프로그래밍" 중 이 주제에 대한 방향성과 관련한 내용을 참고했습니다.

"추천하는 방법은 모든 연관관계에 지연 로딩을 사용하는 것이다. 그리고 애플리케이션 개발이 어느 정도 완료단계에 왔을 때 실제 사용하는 상황을 보고 꼭 필요한 곳에만 즉시 로딩을 사용하도록 최적화하면 된다."

위 방향 그대로 우선 지연로딩으로 설정했고, 추후 서비스 개발이 완료 시점이 됐을 때 이 주제에 관한 분석 및 테스트를 진행할 예정입니다! 해당 분석이 진행된 이후 결과는 다시 이 곳에 업데이트할 예정입니다 :)

___

## 영속성 전이 : 회원이 탈퇴하면 탈퇴한 회원과 관련된 정보를 삭제하고 싶은데요? 

위 기능을 구현하기 위해서 **영속성 전이** 옵션 중 **Cascade.REMOVE**을 활용했습니다. 

___







